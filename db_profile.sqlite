-- ============================================
-- 1. USERS TABLE (Kullanıcı Profili)
-- ============================================
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    nickname VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    profile_picture VARCHAR(255) DEFAULT '/default-avatar.png',
    language VARCHAR(10) DEFAULT 'tr',
    level INTEGER DEFAULT 1,
    level_progress INTEGER DEFAULT 0 CHECK (level_progress >= 0 AND level_progress <= 100),
    total_xp INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index'ler
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);


-- ============================================
-- 2. GAME_STATISTICS TABLE (Oyun İstatistikleri)
-- ============================================
CREATE TABLE game_statistics (
    stat_id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL,

    -- Genel İstatistikler
    total_games INTEGER DEFAULT 0,
    total_wins INTEGER DEFAULT 0,
    total_losses INTEGER DEFAULT 0,
    win_rate REAL DEFAULT 0.00,

    -- Streak Bilgileri
    current_streak INTEGER DEFAULT 0,
    best_streak INTEGER DEFAULT 0,

    -- Süre İstatistikleri (saniye cinsinden)
    total_playtime INTEGER DEFAULT 0,
    average_game_duration INTEGER DEFAULT 0,
    fastest_win_time INTEGER DEFAULT NULL,
    longest_game_time INTEGER DEFAULT NULL,

    -- Performans Metrikleri
    average_score_difference DECIMAL(5,2) DEFAULT 0.00,
    speed INTEGER DEFAULT 50 CHECK (speed >= 0 AND speed <= 100),
    endurance INTEGER DEFAULT 50 CHECK (endurance >= 0 AND endurance <= 100),
    strategy INTEGER DEFAULT 50 CHECK (strategy >= 0 AND strategy <= 100),
    attack INTEGER DEFAULT 50 CHECK (attack >= 0 AND attack <= 100),
    defense INTEGER DEFAULT 50 CHECK (defense >= 0 AND defense <= 100),
    accuracy INTEGER DEFAULT 50 CHECK (accuracy >= 0 AND accuracy <= 100),

    -- Haftalık Aktivite (Her Pazartesi sıfırlanır)
    weekly_monday INTEGER DEFAULT 0,
    weekly_tuesday INTEGER DEFAULT 0,
    weekly_wednesday INTEGER DEFAULT 0,
    weekly_thursday INTEGER DEFAULT 0,
    weekly_friday INTEGER DEFAULT 0,
    weekly_saturday INTEGER DEFAULT 0,
    weekly_sunday INTEGER DEFAULT 0,
    week_reset_date DATE DEFAULT CURRENT_DATE,

    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- Index
CREATE INDEX idx_game_stats_user ON game_statistics(user_id);


-- ============================================
-- 3. QUARTERLY_PROGRESS TABLE (Çeyreklik İlerleme)
-- ============================================
CREATE TABLE quarterly_progress (
    progress_id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    year INTEGER NOT NULL,
    quarter INTEGER NOT NULL CHECK (quarter >= 1 AND quarter <= 4),
    total_games INTEGER DEFAULT 0,
    total_wins INTEGER DEFAULT 0,

    UNIQUE(user_id, year, quarter),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- Index'ler
CREATE INDEX idx_quarterly_user ON quarterly_progress(user_id);
CREATE INDEX idx_quarterly_year ON quarterly_progress(year, quarter);


-- ============================================
-- 4. TOURNAMENTS TABLE (Turnuvalar)
-- ============================================
CREATE TABLE tournaments (
    tournament_id SERIAL PRIMARY KEY,
    tournament_name VARCHAR(100) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    year INTEGER NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'upcoming', -- upcoming, ongoing, completed
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index
CREATE INDEX idx_tournaments_year ON tournaments(year);
CREATE INDEX idx_tournaments_dates ON tournaments(start_date, end_date);


-- ============================================
-- 5. MATCH_HISTORY TABLE (Maç Geçmişi)
-- ============================================
CREATE TABLE match_history (
    match_id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    opponent_username VARCHAR(50) NOT NULL,
    user_score INTEGER NOT NULL,
    opponent_score INTEGER NOT NULL,
    duration INTEGER NOT NULL, -- saniye cinsinden
    result VARCHAR(10) NOT NULL CHECK (result IN ('win', 'loss')),
    tournament_id INTEGER DEFAULT NULL,
    match_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (tournament_id) REFERENCES tournaments(tournament_id) ON DELETE SET NULL
);

-- Index'ler
CREATE INDEX idx_match_user ON match_history(user_id);
CREATE INDEX idx_match_date ON match_history(match_date DESC);
CREATE INDEX idx_match_tournament ON match_history(tournament_id);
CREATE INDEX idx_match_result ON match_history(user_id, result);


-- ============================================
-- 6. TOURNAMENT_PARTICIPATION TABLE (Turnuva Katılımı)
-- ============================================
CREATE TABLE tournament_participation (
    participation_id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    tournament_id INTEGER NOT NULL,
    total_matches INTEGER DEFAULT 0,
    total_wins INTEGER DEFAULT 0,
    total_losses INTEGER DEFAULT 0,
    ranking INTEGER DEFAULT NULL,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(user_id, tournament_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (tournament_id) REFERENCES tournaments(tournament_id) ON DELETE CASCADE
);

-- Index'ler
CREATE INDEX idx_tournament_part_user ON tournament_participation(user_id);
CREATE INDEX idx_tournament_part_tournament ON tournament_participation(tournament_id);


-- ============================================
-- 7. ACHIEVEMENTS TABLE (Başarımlar)
-- ============================================
CREATE TABLE achievements (
    achievement_id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL,

    -- Tarih bazlı başarımlar
    first_win_date TIMESTAMP DEFAULT NULL,
    first_10_streak_date TIMESTAMP DEFAULT NULL,
    first_quick_win_date TIMESTAMP DEFAULT NULL, -- 3 dakikadan kısa

    -- 100 Maç Kazanma
    wins_100_achieved BOOLEAN DEFAULT FALSE,
    wins_100_date TIMESTAMP DEFAULT NULL,
    wins_100_progress INTEGER DEFAULT 0,

    -- 25 Üst Üste Kazanma
    streak_25_achieved BOOLEAN DEFAULT FALSE,
    streak_25_date TIMESTAMP DEFAULT NULL,
    streak_25_progress INTEGER DEFAULT 0,

    -- 500 Maç Oynama
    games_500_achieved BOOLEAN DEFAULT FALSE,
    games_500_date TIMESTAMP DEFAULT NULL,
    games_500_progress INTEGER DEFAULT 0,

    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- Index
CREATE INDEX idx_achievements_user ON achievements(user_id);


-- ============================================
-- TRIGGERS (Otomatik Güncellemeler)
-- ============================================

-- Updated_at otomatik güncelleme fonksiyonu
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger'lar
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_game_stats_updated_at BEFORE UPDATE ON game_statistics
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_achievements_updated_at BEFORE UPDATE ON achievements
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();


-- ============================================
-- VIEWS (Kolay Erişim için)
-- ============================================

-- Kullanıcı profil özeti
CREATE VIEW user_profile_summary AS
SELECT
    u.user_id,
    u.username,
    u.nickname,
    u.email,
    u.profile_picture,
    u.language,
    u.level,
    u.level_progress,
    u.total_xp,
    gs.total_games,
    gs.total_wins,
    gs.total_losses,
    CASE
        WHEN gs.total_games > 0
        THEN ROUND((gs.total_wins::DECIMAL / gs.total_games) * 100, 2)
        ELSE 0
    END as win_rate,
    gs.current_streak,
    gs.best_streak
FROM users u
LEFT JOIN game_statistics gs ON u.user_id = gs.user_id;


-- Son 4 maç view
CREATE VIEW recent_matches AS
SELECT
    mh.*,
    ROW_NUMBER() OVER (PARTITION BY mh.user_id ORDER BY mh.match_date DESC) as rn
FROM match_history mh;


-- ============================================
-- ÖRNEK VERİ EKLEME
-- ============================================

-- Kullanıcı oluşturma
INSERT INTO users (username, nickname, email, password_hash, language)
VALUES ('john_doe', 'Johnny', 'john@example.com', 'hashed_password_here', 'tr');

-- Game statistics oluşturma
INSERT INTO game_statistics (user_id)
VALUES (1);

-- Achievements oluşturma
INSERT INTO achievements (user_id)
VALUES (1);

-- ============================================
-- WIN_RATE Otomatik Hesaplama Trigger
-- ============================================
CREATE TRIGGER calculate_win_rate
AFTER UPDATE OF total_games, total_wins ON game_statistics
FOR EACH ROW
BEGIN
    UPDATE game_statistics
    SET win_rate = CASE
        WHEN NEW.total_games > 0
        THEN ROUND((CAST(NEW.total_wins AS REAL) / NEW.total_games) * 100, 2)
        ELSE 0
    END
    WHERE stat_id = NEW.stat_id;
END;
